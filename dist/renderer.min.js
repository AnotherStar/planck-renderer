const{World:World}=planck;class Viewer{constructor(e={}){const t={canvas:document.querySelector("#game"),world:new World,width:80,height:60};this.options=Object.assign(t,e),this.step=e.step,this.world=e.world,this.keydown=e.keydown,this.paused=!1,this.debug=!1,this.x=0,this.y=0,this.scaleY=-1,this.ratio=16,this.hz=60,this.speed=1,this.background="#222",this.renderer=new Renderer(this.world,this),this.keys={},this.keysProxy=new Proxy(this.keys,{get(e,t){const i=t.split(",");if(i.length>1)for(const t of i)if(e[t])return e[t];return e[t]}}),this.stage=null,this.test=null,this.initStage()}initStage(){document.addEventListener("keydown",e=>{this.keys[e.keyCode]=!0,this.keydown&&this.keydown(this.keysProxy)}),document.addEventListener("keyup",e=>{delete this.keys[e.keyCode]}),Stage(e=>{this.stage=e,e.MAX_ELAPSE=1e3/30,e.on("resume",()=>{this.paused=!1}),e.on("pause",()=>{this.paused=!0});let t=0,i=0;e.tick(()=>{t===this.x&&i===this.y||(this.renderer.offset(-this.x,-this.y),t=this.x,i=this.y)}),this.renderer.tick((e,t)=>{"function"==typeof this.step&&this.step(e,t)}),e.background(this.background),e.viewbox(this.options.width,this.options.height),e.pin("alignX",-.5),e.pin("alignY",-.5),e.prepend(this.renderer)})}resume(){this.stage.resume()}pause(){this.stage.pause()}startUpdate(){this.renderer.start()}}class Renderer extends Stage{constructor(e,t={}){super();const i=t.ratio||16,s={speed:1,hz:60,scaleY:-1,ratio:i,lineWidth:2/i};this.options=Object.assign({},s,t),this.world=e,e.on("remove-fixture",e=>{e.ui&&e.ui.remove()}),e.on("remove-joint",e=>{e.ui&&e.ui.remove()})}start(){const e=1/this.options.hz;let t=0;this.tick(i=>{for(i=.001*i*this.options.speed,t+=i;t>e;)this.world.step(e),t-=e;return this.renderWorld(),!0},!0)}renderWorld(){const e=this.world,t=this.options;for(let i=e.getBodyList();i;i=i.getNext())for(let e=i.getFixtureList();e;e=e.getNext()){if(!e.ui){e.render&&e.render.stroke?t.strokeStyle=e.render.stroke:i.render&&i.render.stroke?t.strokeStyle=i.render.stroke:i.isDynamic()?t.strokeStyle="rgba(255,255,255,0.9)":i.isKinematic()?t.strokeStyle="rgba(255,255,255,0.7)":i.isStatic()&&(t.strokeStyle="rgba(255,255,255,0.5)"),e.render&&e.render.fill?t.fillStyle=e.render.fill:i.render&&i.render.fill?t.fillStyle=i.render.fill:t.fillStyle="";const s=e.getType(),n=e.getShape();"circle"===s&&(e.ui=this.drawCircle(n)),"edge"===s&&(e.ui=this.drawEdge(n)),"polygon"===s&&(e.ui=this.drawPolygon(n)),"chain"===s&&(e.ui=this.drawChain(n)),e.ui&&e.ui.appendTo(this)}if(e.ui){const s=i.getPosition(),n=i.getAngle();e.ui.__lastX===s.x&&e.ui.__lastY===s.y&&e.ui.__lastR===n||(e.ui.__lastX=s.x,e.ui.__lastY=s.y,e.ui.__lastR=n,e.ui.offset(s.x,t.scaleY*s.y),e.ui.rotate(t.scaleY*n))}}for(let i=e.getJointList();i;i=i.getNext()){const e=i.getAnchorA(),s=i.getAnchorB();if(i.ui||(t.strokeStyle="rgba(255,255,255,0.2)",i.ui=this.drawJoint(i,t),i.ui.pin("handle",.5),i.ui&&i.ui.appendTo(this)),i.ui){const n=.5*(e.x+s.x),r=t.scaleY*(e.y+s.y)*.5,o=e.x-s.x,a=t.scaleY*(e.y-s.y),l=Math.sqrt(o*o+a*a);i.ui.width(l),i.ui.rotate(Math.atan2(a,o)),i.ui.offset(n,r)}}}drawJoint(e){const t=this.options,i=t.lineWidth,s=t.ratio,n=Stage.canvas(function(e){this.size(10+2*i,2*i,s),e.scale(s,s),e.beginPath(),e.moveTo(i,i),e.lineTo(i+10,i),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()});return Stage.image(n).stretch()}drawCircle(e){const t=this.options,i=t.lineWidth,s=t.ratio,n=e.m_radius,r=n+i,o=n+i,a=2*n+2*i,l=2*n+2*i,h=Stage.canvas(function(e){this.size(a,l,s),e.scale(s,s),e.arc(r,o,n,0,2*Math.PI),t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill()),e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),d=Stage.image(h).offset(e.m_p.x-r,t.scaleY*e.m_p.y-o);return Stage.create().append(d)}drawEdge(e){const t=this.options,i=t.lineWidth,s=t.ratio,n=e.m_vertex1,r=e.m_vertex2,o=r.x-n.x,a=r.y-n.y,l=Math.sqrt(o*o+a*a),h=Stage.canvas(function(e){this.size(l+2*i,2*i,s),e.scale(s,s),e.beginPath(),e.moveTo(i,i),e.lineTo(i+l,i),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),d=Math.min(n.x,r.x),c=Math.min(t.scaleY*n.y,t.scaleY*r.y),u=Stage.image(h);return u.rotate(t.scaleY*Math.atan2(a,o)),u.offset(d-i,c-i),Stage.create().append(u)}drawPolygon(e){const t=this.options,i=t.lineWidth,s=t.ratio,n=e.m_vertices;if(!n.length)return;let r=1/0,o=1/0,a=-1/0,l=-1/0;for(const e of n)r=Math.min(r,e.x),a=Math.max(a,e.x),o=Math.min(o,t.scaleY*e.y),l=Math.max(l,t.scaleY*e.y);const h=a-r,d=l-o,c=Stage.canvas(function(e){this.size(h+2*i,d+2*i,s),e.scale(s,s),e.beginPath();for(let s=0;s<n.length;++s){const a=n[s],l=a.x-r+i,h=t.scaleY*a.y-o+i;0==s?e.moveTo(l,h):e.lineTo(l,h)}n.length>2&&e.closePath(),t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill(),e.closePath()),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),u=Stage.image(c);return u.offset(r-i,o-i),Stage.create().append(u)}drawChain(e){const t=this.options,i=t.lineWidth,s=t.ratio,n=e.m_vertices;if(!n.length)return;let r=1/0,o=1/0,a=-1/0,l=-1/0;for(const e of n)r=Math.min(r,e.x),a=Math.max(a,e.x),o=Math.min(o,t.scaleY*e.y),l=Math.max(l,t.scaleY*e.y);const h=a-r,d=l-o,c=Stage.canvas(function(e){this.size(h+2*i,d+2*i,s),e.scale(s,s),e.beginPath();for(let s=0;s<n.length;++s){const a=n[s],l=a.x-r+i,h=t.scaleY*a.y-o+i;0==s?e.moveTo(l,h):e.lineTo(l,h)}n.length,t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill(),e.closePath()),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),u=Stage.image(c);return u.offset(r-i,o-i),Stage.create().append(u)}}export default Viewer;