class Camera{constructor(e,t){this.viewer=e,this.fixed=!1,this.speed=0,t&&this.moveTo(t.x,t.y)}setSmooth(e){this.speed=e}moveTo(e,t){if(0===this.speed)return e&&(this.viewer.x=e),void(t&&(this.viewer.y=t));const i=e-this.viewer.x,s=t-this.viewer.y,r=Math.max(Math.abs(i),Math.abs(s)),o=Math.sqrt((e-this.viewer.x)**2+(t-this.viewer.y)**2);0!==Math.floor(o)&&(this.viewer.x+=i/r*this.speed,this.viewer.y+=s/r*this.speed)}lockIn(e,t){this.moveTo(e,t),this.fixed=!0}unlock(){this.fixed=!1}follow(e,t=0){if(this.fixed)return;let i,s;e.y>this.viewer.y+t?s=-e.y+t:e.y<this.viewer.y-t&&(s=-e.y-t),e.x>this.viewer.x+t?i=e.x-t:e.x<this.viewer.x-t&&(i=e.x+t),this.moveTo(i,s)}}export{Camera};class Renderer extends Stage{constructor(e,t={}){super(),this.options=Object.assign(t,{lineWidth:2/t.ratio}),this.world=e,e.on("remove-fixture",e=>{e.ui&&e.ui.remove()}),e.on("remove-joint",e=>{e.ui&&e.ui.remove()})}start(){const e=1/this.options.hz;let t=0;this.tick(i=>{for(i=.001*i*this.options.speed,t+=i;t>e;)this.world.step(e),t-=e;return this.renderWorld(),!0},!0)}renderWorld(){const e=this.world,t=this.options;for(let i=e.getBodyList();i;i=i.getNext())for(let e=i.getFixtureList();e;e=e.getNext()){if(!e.ui){e.render&&e.render.stroke?t.strokeStyle=e.render.stroke:i.render&&i.render.stroke?t.strokeStyle=i.render.stroke:i.isDynamic()?t.strokeStyle=t.globalStrokeStyle.dynamic:i.isKinematic()?t.strokeStyle=t.globalStrokeStyle.kinematic:i.isStatic()&&(t.strokeStyle=t.globalStrokeStyle.static),e.render&&e.render.fill?t.fillStyle=e.render.fill:i.render&&i.render.fill?t.fillStyle=i.render.fill:t.fillStyle=this.options.globalFillStyle;const s=e.getType(),r=e.getShape();"circle"===s&&(e.ui=this.drawCircle(r)),"edge"===s&&(e.ui=this.drawEdge(r)),"polygon"===s&&(e.ui=this.drawPolygon(r)),"chain"===s&&(e.ui=this.drawChain(r)),e.ui&&e.ui.appendTo(this)}if(e.ui){const s=i.getPosition(),r=i.getAngle();e.ui.__lastX===s.x&&e.ui.__lastY===s.y&&e.ui.__lastR===r||(e.ui.__lastX=s.x,e.ui.__lastY=s.y,e.ui.__lastR=r,e.ui.offset(s.x,t.scaleY*s.y),e.ui.rotate(t.scaleY*r))}}for(let i=e.getJointList();i;i=i.getNext()){const e=i.getAnchorA(),s=i.getAnchorB();if(i.ui||(t.strokeStyle="rgba(255,255,255,0.2)",i.ui=this.drawJoint(i),i.ui.pin("handle",.5),i.ui&&i.ui.appendTo(this)),i.ui){const r=.5*(e.x+s.x),o=t.scaleY*(e.y+s.y)*.5,a=e.x-s.x,l=t.scaleY*(e.y-s.y),n=Math.sqrt(a*a+l*l);i.ui.width(n),i.ui.rotate(Math.atan2(l,a)),i.ui.offset(r,o)}}}drawJoint(e){const t=this.options,i=t.lineWidth,s=t.ratio,r=Stage.canvas(function(e){this.size(10+2*i,2*i,s),e.scale(s,s),e.beginPath(),e.moveTo(i,i),e.lineTo(i+10,i),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()});return Stage.image(r).stretch()}drawCircle(e){const t=this.options,i=t.lineWidth,s=t.ratio,r=e.m_radius,o=r+i,a=r+i,l=2*r+2*i,n=2*r+2*i,h=Stage.canvas(function(e){this.size(l,n,s),e.scale(s,s),e.arc(o,a,r,0,2*Math.PI),t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill()),e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),d=Stage.image(h).offset(e.m_p.x-o,t.scaleY*e.m_p.y-a);return Stage.create().append(d)}drawEdge(e){const t=this.options,i=t.lineWidth,s=t.ratio,r=e.m_vertex1,o=e.m_vertex2,a=o.x-r.x,l=o.y-r.y,n=Math.sqrt(a*a+l*l),h=Stage.canvas(function(e){this.size(n+2*i,2*i,s),e.scale(s,s),e.beginPath(),e.moveTo(i,i),e.lineTo(i+n,i),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),d=Math.min(r.x,o.x),c=Math.min(t.scaleY*r.y,t.scaleY*o.y),y=Stage.image(h);return y.rotate(t.scaleY*Math.atan2(l,a)),y.offset(d-i,c-i),Stage.create().append(y)}drawPolygon(e){const t=this.options,i=t.lineWidth,s=t.ratio,r=e.m_vertices;if(!r.length)return;let o=1/0,a=1/0,l=-1/0,n=-1/0;for(const e of r)o=Math.min(o,e.x),l=Math.max(l,e.x),a=Math.min(a,t.scaleY*e.y),n=Math.max(n,t.scaleY*e.y);const h=l-o,d=n-a,c=Stage.canvas(function(e){this.size(h+2*i,d+2*i,s),e.scale(s,s),e.beginPath();for(let s=0;s<r.length;++s){const l=r[s],n=l.x-o+i,h=t.scaleY*l.y-a+i;0==s?e.moveTo(n,h):e.lineTo(n,h)}r.length>2&&e.closePath(),t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill(),e.closePath()),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),y=Stage.image(c);return y.offset(o-i,a-i),Stage.create().append(y)}drawChain(e){const t=this.options,i=t.lineWidth,s=t.ratio,r=e.m_vertices;if(!r.length)return;let o=1/0,a=1/0,l=-1/0,n=-1/0;for(const e of r)o=Math.min(o,e.x),l=Math.max(l,e.x),a=Math.min(a,t.scaleY*e.y),n=Math.max(n,t.scaleY*e.y);const h=l-o,d=n-a,c=Stage.canvas(function(e){this.size(h+2*i,d+2*i,s),e.scale(s,s),e.beginPath();for(let s=0;s<r.length;++s){const l=r[s],n=l.x-o+i,h=t.scaleY*l.y-a+i;0==s?e.moveTo(n,h):e.lineTo(n,h)}r.length,t.fillStyle&&(e.fillStyle=t.fillStyle,e.fill(),e.closePath()),e.lineCap="round",e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.stroke()}),y=Stage.image(c);return y.offset(o-i,a-i),Stage.create().append(y)}}export{Renderer};const{World:World}=planck;class Viewer{constructor(e={}){const t={world:new World,width:80,height:60,background:"#222",scaleY:-1,ratio:16,hz:60,speed:1,debug:!1,globalStrokeStyle:{dynamic:"rgba(255, 255, 255, 0.9)",kinematic:"rgba(255, 255, 255, 0.7)",static:"rgba(255, 255, 255, 0.5)"},globalFillStyle:""},i=Object.assign(t.globalStrokeStyle,e.globalStrokeStyle||{});this.options=Object.assign(t,e,{globalStrokeStyle:i}),this.step=e.step,this.world=e.world,this.keydown=e.keydown,this.canvas=null,this.stage=null,this.camera=null,this.isReady=!1,this.ready=(()=>this.isReady=!0),this.paused=!1,this.x=0,this.y=0,this.renderer=new Renderer(this.world,this.options),this.keys={},this.keysProxy=new Proxy(this.keys,{get(e,t){const i=t.split(",");if(i.length>1)for(const t of i)if(e[t])return e[t];return e[t]}}),this.initStage()}initStage(){document.addEventListener("keydown",e=>{this.keys[e.keyCode]=!0,this.keydown&&this.keydown(this.keysProxy)}),document.addEventListener("keyup",e=>{delete this.keys[e.keyCode]}),Stage((e,t)=>{this.stage=e,this.canvas=t,e.MAX_ELAPSE=1e3/30,e.on("resume",()=>{this.paused=!1}),e.on("pause",()=>{this.paused=!0});let i=0,s=0;e.tick(()=>{i===this.x&&s===this.y||(this.renderer.offset(-this.x,-this.y),i=this.x,s=this.y)}),this.renderer.tick((e,t)=>{"function"==typeof this.step&&this.isReady&&this.step(e,t)}),e.background(this.options.background),e.viewbox(this.options.width,this.options.height),e.pin("alignX",-.5),e.pin("alignY",-.5),e.prepend(this.renderer),this.camera=new Camera(this),this.isReady=this.ready()})}resume(){this.stage.resume()}pause(){this.stage.pause()}startUpdate(){this.renderer.start()}}export default Viewer;export{Viewer};